
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Methods for Improving PINNs’ Accuracy &#8212; PINNs</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'content/Lecture_5';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Introduction to Physics Informed Neural Networks (PINNs)" href="Lecture_4.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="Lecture_1.html">
  
  
  
  
  
  
    <p class="title logo__title">PINNs</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="Lecture_1.html">
                    <no title>
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Lecture_2.html">Day 2: Fundamentals of Machine Learning</a></li>






<li class="toctree-l1"><a class="reference internal" href="Lecture_3.html">Introduction to neural networks</a></li>




<li class="toctree-l1"><a class="reference internal" href="Lecture_4.html">Introduction to Physics Informed Neural Networks (PINNs)</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Methods for Improving PINNs’ Accuracy</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/content/Lecture_5.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Methods for Improving PINNs’ Accuracy</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#curriculim-learning">Curriculim Learning</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-strategy">Sampling Strategy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-weights">Adaptive Weights</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="methods-for-improving-pinns-accuracy">
<h1>Methods for Improving PINNs’ Accuracy<a class="headerlink" href="#methods-for-improving-pinns-accuracy" title="Link to this heading">#</a></h1>
<p>As we have seen in the last lecture, implementing a PINNs model is relatively easy using Automatic Differentiation (AD), but in many cases it is very difficult to train it. One reason is that adding physics regularizer as a soft contstrain complicates the loss landscape thus results in a difficult optimization. There are some methods for improving the optimization process, we can split them into 4 sections.</p>
<ol class="arabic simple">
<li><p><strong>Non-dimensionalization:</strong> We talked about this last lecture. It is a very curicial method, and it must be the first step especially working with real data.</p></li>
<li><p><strong>Network Architecture:</strong> Things like, Fourier features and enforcing hard boundary conditions. These methods are build into the networks architecture. We also talked about Fourier features, which encodes the input coordinates into high frequency signals and passes this information to the network. Hard boundary conditions on the other hand changes the output of the network by passing it through a function to enforce the boundary conditions. For example if a zero boundary condition, <span class="math notranslate nohighlight">\(u(x=0) = 0\)</span>, then we can multiply the output of the network with x. In this case the boundary conditions will always be enforced as at <span class="math notranslate nohighlight">\(x=0 \rightarrow\)</span> <span class="math notranslate nohighlight">\(NN(x) \cdot x \overset{!}{=}0\)</span>. This is also a powerfull techique, however since the network output is scaled by x the derivaties of it must be defined accordingly.</p></li>
<li><p><strong>Training Algorightm:</strong> Methods such as adaptive weights, causal training, curriculum learning are all important methods to improve the training process.</p></li>
<li><p><strong>Data Sampling</strong>: The sampling strategy also plays a curicial role. Adaptive sampling strategies can make a big difference, especially when the problem in focus has steep gradients.</p></li>
</ol>
<p>In this lecture we will investigate some of these methods.</p>
<section id="curriculim-learning">
<h2>Curriculim Learning<a class="headerlink" href="#curriculim-learning" title="Link to this heading">#</a></h2>
<p>To understand the effect of curriculum learning lets consider the 1d advection equation:</p>
<div class="math notranslate nohighlight">
\[
\frac{\partial u}{\partial t} + v \frac{\partial u}{\partial x} = 0
\]</div>
<p>where  <span class="math notranslate nohighlight">\(u(x, t)\)</span>  is the solution, <span class="math notranslate nohighlight">\(v\)</span> is the advection speed, <span class="math notranslate nohighlight">\(x\)</span> is the spatial coordinate, and <span class="math notranslate nohighlight">\(t\)</span> is time, with periodic conditions:</p>
<div class="math notranslate nohighlight">
\[
u(x, 0) = sin(\frac{2\pi x}{L}) \quad \text{and} \quad u(0,t) = u(L, t)
\]</div>
<p>the analytical solution is:</p>
<div class="math notranslate nohighlight">
\[
u(x, t) = sin(\frac{2\pi(x-\nu t)}{L})
\]</div>
<p>Firstly lets see how regular PINN will be with the problem.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># importing the required libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># device = &#39;cuda&#39; if torch.cuda.is_available() else &#39;cpu&#39;</span>
<span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span>

<span class="c1"># Set random seed for reproducibility</span>
<span class="k">def</span><span class="w"> </span><span class="nf">set_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

<span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># A basic MLP architecture</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MLP</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arch</span><span class="p">,</span> <span class="n">act</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MLP</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arch</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">arch</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">arch</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">arch</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span> 
                <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">act</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

<span class="c1"># Constant for the problem</span>
<span class="n">L</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="c1"># m</span>

<span class="n">u_real_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">V</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">V</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">L</span><span class="p">)</span> <span class="c1"># analytical solution</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>A module that was compiled using NumPy 1.x cannot be run in
NumPy 2.2.6 as it may crash. To support both 1.x and 2.x
versions of NumPy, modules must be compiled with NumPy 2.0.
Some module may need to rebuild instead e.g. with &#39;pybind11&gt;=2.12&#39;.

If you are a user of the module, the easiest solution will be to
downgrade to &#39;numpy&lt;2&#39; or try to upgrade the affected module.
We expect that some modules will need time to support NumPy 2.

Traceback (most recent call last):  File &quot;/Library/Frameworks/Python.framework/Versions/3.10/lib/python3.10/runpy.py&quot;, line 196, in _run_module_as_main
    return _run_code(code, main_globals, None,
  File &quot;/Library/Frameworks/Python.framework/Versions/3.10/lib/python3.10/runpy.py&quot;, line 86, in _run_code
    exec(code, run_globals)
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/ipykernel_launcher.py&quot;, line 18, in &lt;module&gt;
    app.launch_new_instance()
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/traitlets/config/application.py&quot;, line 1075, in launch_instance
    app.start()
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/ipykernel/kernelapp.py&quot;, line 739, in start
    self.io_loop.start()
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/tornado/platform/asyncio.py&quot;, line 211, in start
    self.asyncio_loop.run_forever()
  File &quot;/Library/Frameworks/Python.framework/Versions/3.10/lib/python3.10/asyncio/base_events.py&quot;, line 600, in run_forever
    self._run_once()
  File &quot;/Library/Frameworks/Python.framework/Versions/3.10/lib/python3.10/asyncio/base_events.py&quot;, line 1896, in _run_once
    handle._run()
  File &quot;/Library/Frameworks/Python.framework/Versions/3.10/lib/python3.10/asyncio/events.py&quot;, line 80, in _run
    self._context.run(self._callback, *self._args)
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/ipykernel/kernelbase.py&quot;, line 519, in dispatch_queue
    await self.process_one()
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/ipykernel/kernelbase.py&quot;, line 508, in process_one
    await dispatch(*args)
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/ipykernel/kernelbase.py&quot;, line 400, in dispatch_shell
    await result
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/ipykernel/ipkernel.py&quot;, line 368, in execute_request
    await super().execute_request(stream, ident, parent)
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/ipykernel/kernelbase.py&quot;, line 767, in execute_request
    reply_content = await reply_content
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/ipykernel/ipkernel.py&quot;, line 455, in do_execute
    res = shell.run_cell(
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/ipykernel/zmqshell.py&quot;, line 577, in run_cell
    return super().run_cell(*args, **kwargs)
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/IPython/core/interactiveshell.py&quot;, line 3077, in run_cell
    result = self._run_cell(
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/IPython/core/interactiveshell.py&quot;, line 3132, in _run_cell
    result = runner(coro)
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/IPython/core/async_helpers.py&quot;, line 128, in _pseudo_sync_runner
    coro.send(None)
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/IPython/core/interactiveshell.py&quot;, line 3336, in run_cell_async
    has_raised = await self.run_ast_nodes(code_ast.body, cell_name,
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/IPython/core/interactiveshell.py&quot;, line 3519, in run_ast_nodes
    if await self.run_code(code, result, async_=asy):
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/IPython/core/interactiveshell.py&quot;, line 3579, in run_code
    exec(code_obj, self.user_global_ns, self.user_ns)
  File &quot;/var/folders/qh/w33tqq7j74181hmc1ky5lm080000gn/T/ipykernel_51398/2955194164.py&quot;, line 4, in &lt;module&gt;
    import torch
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/torch/__init__.py&quot;, line 1477, in &lt;module&gt;
    from .functional import *  # noqa: F403
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/torch/functional.py&quot;, line 9, in &lt;module&gt;
    import torch.nn.functional as F
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/torch/nn/__init__.py&quot;, line 1, in &lt;module&gt;
    from .modules import *  # noqa: F403
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/torch/nn/modules/__init__.py&quot;, line 35, in &lt;module&gt;
    from .transformer import TransformerEncoder, TransformerDecoder, \
  File &quot;/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/torch/nn/modules/transformer.py&quot;, line 20, in &lt;module&gt;
    device: torch.device = torch.device(torch._C._get_default_device()),  # torch.device(&#39;cpu&#39;),
/Users/ulye_kak_raz/Desktop/pinn-course/.venv/lib/python3.10/site-packages/torch/nn/modules/transformer.py:20: UserWarning: Failed to initialize NumPy: _ARRAY_API not found (Triggered internally at /Users/runner/work/pytorch/pytorch/pytorch/torch/csrc/utils/tensor_numpy.cpp:84.)
  device: torch.device = torch.device(torch._C._get_default_device()),  # torch.device(&#39;cpu&#39;),
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">pinn_advection</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">net_u</span><span class="p">,</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(),</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">pinn_advection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net_u</span> <span class="o">=</span> <span class="n">net_u</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">loss_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">net_u_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_u</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">u</span>
    <span class="c1"># Calculates the loss for the PDE</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loss_pde</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_u_forward</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">u_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">u_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">pde_residual</span> <span class="o">=</span> <span class="n">u_t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">*</span> <span class="n">u_x</span>
        <span class="n">pde_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">pde_residual</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pde_residual</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pde_loss</span>
    
    <span class="c1"># Calculates the loss for the initial condition u(x, 0) = sin(x)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loss_ic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_u_forward</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">u_real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">ic_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">u_real</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ic_loss</span>

    <span class="c1"># Calculates the loss for the boundary conditions u(0, t) = u(L, t)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loss_bc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u_l_bc</span><span class="p">,</span> <span class="n">u_r_bc</span><span class="p">):</span>
        <span class="n">bc_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">u_l_bc</span><span class="p">,</span> <span class="n">u_r_bc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bc_loss</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">pinn_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

        <span class="n">x_dom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t_dom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x_ic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t_ic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x_bc_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_left_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t_bc_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_left_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x_bc_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_right_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t_bc_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_right_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Calculate losses</span>
        <span class="n">pde_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_pde</span><span class="p">(</span><span class="n">x_dom</span><span class="p">,</span> <span class="n">t_dom</span><span class="p">)</span>
        <span class="n">ic_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_ic</span><span class="p">(</span><span class="n">x_ic</span><span class="p">,</span> <span class="n">t_ic</span><span class="p">)</span>

        <span class="n">u_l_bc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_u_forward</span><span class="p">(</span><span class="n">x_bc_left</span><span class="p">,</span> <span class="n">t_bc_left</span><span class="p">)</span>
        <span class="n">u_r_bc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_u_forward</span><span class="p">(</span><span class="n">x_bc_right</span><span class="p">,</span> <span class="n">t_bc_right</span><span class="p">)</span>
        <span class="n">bc_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_bc</span><span class="p">(</span><span class="n">u_l_bc</span><span class="p">,</span> <span class="n">u_r_bc</span><span class="p">)</span>

        <span class="n">total_loss</span> <span class="o">=</span> <span class="n">pde_loss</span> <span class="o">+</span>  <span class="n">ic_loss</span> <span class="o">+</span>  <span class="n">bc_loss</span> <span class="c1"># combine losses</span>
        <span class="n">total_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span> <span class="c1"># backpropagate the total loss</span>

        <span class="c1"># log the losses </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer_name</span><span class="si">}</span><span class="s1">]: Iteration </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="si">}</span><span class="s1">, Total loss: </span><span class="si">{</span><span class="n">total_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1">, PDE Loss: </span><span class="si">{</span><span class="n">pde_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1">, IC Loss: </span><span class="si">{</span><span class="n">ic_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1">, BC Loss: </span><span class="si">{</span><span class="n">bc_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1">, V: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">total_loss</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train_net</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="p">,</span> <span class="n">bc_left_points</span><span class="p">,</span> <span class="n">bc_right_points</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">,</span> <span class="n">log_interval</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">V</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_interval</span> <span class="o">=</span> <span class="n">log_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain_points</span> <span class="o">=</span> <span class="n">domain_points</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ic_points</span> <span class="o">=</span> <span class="n">ic_points</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc_left_points</span> <span class="o">=</span> <span class="n">bc_left_points</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc_right_points</span> <span class="o">=</span> <span class="n">bc_right_points</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">net_u</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">optimizer</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">LBFGS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_name</span> <span class="o">=</span> <span class="s1">&#39;LBFGS&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_u</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">max_eval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">tolerance_grad</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">tolerance_change</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">line_search_fn</span><span class="o">=</span><span class="s1">&#39;strong_wolfe&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pinn_loss</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_u</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_name</span> <span class="o">=</span> <span class="s1">&#39;Adam&#39;</span>
            <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinn_loss</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="c1"># Predict the solution at given points x and t</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net_u</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_u_forward</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    
    <span class="c1"># Evaluate the model on a grid of points and compare with the analytical solution</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_x</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">num_t</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">net_u</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="c1"># Prepare testing grid</span>
        <span class="n">x_test</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">num_x</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">t_test</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_t</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">x_grid</span><span class="p">,</span> <span class="n">t_grid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">t_test</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
        <span class="n">x_grid_flat</span> <span class="o">=</span> <span class="n">x_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">t_grid_flat</span> <span class="o">=</span> <span class="n">t_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Predict using the trained model</span>
        <span class="n">u_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_grid_flat</span><span class="p">,</span> <span class="n">t_grid_flat</span><span class="p">)</span>

        <span class="c1"># Analytical solution</span>
        <span class="n">u_analytical</span> <span class="o">=</span> <span class="n">u_real_fun</span><span class="p">(</span><span class="n">x_grid_flat</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">t_grid_flat</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">V</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_x</span><span class="p">,</span> <span class="n">num_t</span><span class="p">)</span>

        <span class="c1"># Reshape for comparison</span>
        <span class="n">u_pred</span> <span class="o">=</span> <span class="n">u_pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_x</span><span class="p">,</span> <span class="n">num_t</span><span class="p">)</span>

        <span class="c1"># Calculate errors</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_pred</span> <span class="o">-</span> <span class="n">u_analytical</span><span class="p">)</span>
        
        <span class="c1"># Calculate accuracy as 1 - normalized RMSE</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

        <span class="c1"># Plot prediction vs analytical solution</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">u_pred</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">L</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;rainbow&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;PINN Prediction&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">u_analytical</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;rainbow&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Analytical Solution&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">L</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Absolute Error, Accuracy: </span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_x</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># Number of points in the x direction</span>
<span class="n">num_t</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># Number of points in the t direction</span>

<span class="n">x_lin</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">num_x</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># x grid</span>
<span class="n">t_lin</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_t</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># t grid</span>

<span class="n">x_lin_domain</span> <span class="o">=</span> <span class="n">x_lin</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Exclude the boundaries for collocation points</span>
<span class="n">t_lin_domain</span> <span class="o">=</span> <span class="n">t_lin</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>    <span class="c1"># Exclude the initial condition for collocation points</span>

<span class="c1"># create a grid of points in the domain</span>
<span class="n">x_grid</span><span class="p">,</span> <span class="n">t_grid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_lin_domain</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">t_lin_domain</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
<span class="n">x_grid_flat</span> <span class="o">=</span> <span class="n">x_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">t_grid_flat</span> <span class="o">=</span> <span class="n">t_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">dom_points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x_grid_flat</span><span class="p">,</span> <span class="n">t_grid_flat</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Generate boundary condition points</span>
<span class="n">bc_l_pts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t_lin</span><span class="p">),</span> <span class="n">t_lin</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Boundary at x=0, num_t points</span>
<span class="n">bc_r_pts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">t_lin</span><span class="p">,</span> <span class="n">L</span><span class="p">),</span> <span class="n">t_lin</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Boundary at x=L</span>

<span class="c1"># Generate initial condition points</span>
<span class="n">ic_pts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x_lin</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_lin</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># num_x points</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dom_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">dom_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sampled Domain Points&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bc_l_pts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bc_l_pts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Points (x=0)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bc_r_pts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bc_r_pts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Points (x=L)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ic_pts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ic_pts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial Condition Points&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sampled Domain, Boundary, and Initial Condition Points&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">RuntimeError</span><span class="g g-Whitespace">                              </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">line</span> <span class="mi">25</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span> <span class="n">ic_pts</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x_lin</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_lin</span><span class="p">)),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># num_x points</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="ne">---&gt; </span><span class="mi">25</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dom_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">dom_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sampled Domain Points&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bc_l_pts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bc_l_pts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Points (x=0)&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bc_r_pts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bc_r_pts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Points (x=L)&#39;</span><span class="p">)</span>

<span class="ne">RuntimeError</span>: Numpy is not available
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure size 800x400 with 0 Axes&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arch</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Input layer, hidden layers, output layer</span>
<span class="n">act</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span>  <span class="c1"># Activation function</span>
<span class="n">net_u</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">act</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">pinn_advection</span><span class="p">(</span><span class="n">net_u</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">V_train</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">model</span><span class="o">.</span><span class="n">train_net</span><span class="p">(</span><span class="n">domain_points</span><span class="o">=</span><span class="n">dom_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="o">=</span><span class="n">ic_pts</span><span class="p">,</span> <span class="n">bc_left_points</span><span class="o">=</span><span class="n">bc_l_pts</span><span class="p">,</span> <span class="n">bc_right_points</span><span class="o">=</span><span class="n">bc_r_pts</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">40000</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">,</span> <span class="n">log_interval</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V_train</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">num_x</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_t</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Adam]: Iteration 0, Total loss: 4.940e-01, PDE Loss: 2.441e-04, IC Loss: 4.906e-01, BC Loss: 3.205e-03, V: 1.000
[Adam]: Iteration 10000, Total loss: 2.865e-06, PDE Loss: 1.391e-06, IC Loss: 1.376e-06, BC Loss: 9.798e-08, V: 1.000
[Adam]: Iteration 20000, Total loss: 2.870e-06, PDE Loss: 7.435e-07, IC Loss: 1.826e-06, BC Loss: 3.004e-07, V: 1.000
[Adam]: Iteration 30000, Total loss: 2.787e-06, PDE Loss: 4.420e-07, IC Loss: 1.817e-06, BC Loss: 5.284e-07, V: 1.000
</pre></div>
</div>
<img alt="../_images/8af848236179b6681e47dff3f7ca1c026d1e6a780fc518fb1d928d93e4ab5cee.png" src="../_images/8af848236179b6681e47dff3f7ca1c026d1e6a780fc518fb1d928d93e4ab5cee.png" />
</div>
</div>
<p>Nice, vanilla PINN can predict learn the advection equation at <span class="math notranslate nohighlight">\(\nu = 1\)</span>, but can it also learn if the advection speed increases? Lets try it again for <span class="math notranslate nohighlight">\(\nu = 30\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arch</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Input layer, hidden layers, output layer</span>
<span class="n">act</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span>  <span class="c1"># Activation function</span>
<span class="n">net_u</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">act</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">pinn_advection</span><span class="p">(</span><span class="n">net_u</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">V_train</span> <span class="o">=</span> <span class="mi">30</span>

<span class="n">model</span><span class="o">.</span><span class="n">train_net</span><span class="p">(</span><span class="n">domain_points</span><span class="o">=</span><span class="n">dom_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="o">=</span><span class="n">ic_pts</span><span class="p">,</span> <span class="n">bc_left_points</span><span class="o">=</span><span class="n">bc_l_pts</span><span class="p">,</span> <span class="n">bc_right_points</span><span class="o">=</span><span class="n">bc_r_pts</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">40000</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">,</span> <span class="n">log_interval</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V_train</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">num_x</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_t</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Adam]: Iteration 0, Total loss: 5.038e-01, PDE Loss: 1.541e-02, IC Loss: 4.884e-01, BC Loss: 4.573e-05, V: 30.000
[Adam]: Iteration 10000, Total loss: 1.698e-05, PDE Loss: 9.135e-06, IC Loss: 4.736e-06, BC Loss: 3.107e-06, V: 30.000
[Adam]: Iteration 20000, Total loss: 5.243e-04, PDE Loss: 2.635e-04, IC Loss: 2.239e-04, BC Loss: 3.689e-05, V: 30.000
[Adam]: Iteration 30000, Total loss: 2.346e-06, PDE Loss: 6.166e-07, IC Loss: 1.690e-06, BC Loss: 3.845e-08, V: 30.000
</pre></div>
</div>
<img alt="../_images/f7a777703e2338c9cce68a6aba28ab84a04211e3ce5de5c5208c635daafeb9cc.png" src="../_images/f7a777703e2338c9cce68a6aba28ab84a04211e3ce5de5c5208c635daafeb9cc.png" />
</div>
</div>
<p>Yeaah, it seems to fail for advection larger speed. You can probably see why by looking at the real solution. The frequency of the solution increases, thus regular pinns fail to learn the high frequency relations. Fourier features most likely would help here, but we can also use some transfer learning to improve the optimization. This is where curriculum training comes to play. In curriculum training we can basically train the network first with smallar advection speed then increase the speed as we continue to train further. It is straightforward to implement. The <code class="docutils literal notranslate"><span class="pre">pinn_advection</span></code> class is alredy build that you can pass V values into training. So we just create a loop and train the network from <span class="math notranslate nohighlight">\(\nu = 0.1\)</span> to <span class="math notranslate nohighlight">\(\nu = 30\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">arch</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Input layer, hidden layers, output layer</span>
<span class="n">act</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span>  <span class="c1"># Activation function</span>
<span class="n">net_u</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">act</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">pinn_advection</span><span class="p">(</span><span class="n">net_u</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">V_0</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># Initial value of V</span>
<span class="n">Vcurr</span> <span class="o">=</span> <span class="n">V_0</span>  <span class="c1"># Current value of V</span>
<span class="n">V_last</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># Last value of V</span>
<span class="n">steps</span> <span class="o">=</span> <span class="mi">10</span>
<span class="c1"># we define the V_current as a linear interpolation between V_0 and V_last. So we train 10 steps, 4000 epochs each</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
    <span class="n">V_current</span> <span class="o">=</span> <span class="n">V_0</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="n">V_last</span> <span class="o">-</span> <span class="n">V_0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">steps</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Increment V gradually</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train_net</span><span class="p">(</span><span class="n">domain_points</span><span class="o">=</span><span class="n">dom_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="o">=</span><span class="n">ic_pts</span><span class="p">,</span> <span class="n">bc_left_points</span><span class="o">=</span><span class="n">bc_l_pts</span><span class="p">,</span> <span class="n">bc_right_points</span><span class="o">=</span><span class="n">bc_r_pts</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">,</span> <span class="n">log_interval</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V_current</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">num_x</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_t</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V_last</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Adam]: Iteration 0, Total loss: 4.993e-01, PDE Loss: 1.375e-04, IC Loss: 4.913e-01, BC Loss: 7.781e-03, V: 0.100
[Adam]: Iteration 1000, Total loss: 1.071e-03, PDE Loss: 4.900e-04, IC Loss: 5.182e-04, BC Loss: 6.309e-05, V: 0.100
[Adam]: Iteration 2000, Total loss: 6.259e-03, PDE Loss: 1.418e-04, IC Loss: 1.703e-03, BC Loss: 4.415e-03, V: 0.100
[Adam]: Iteration 3000, Total loss: 1.198e-04, PDE Loss: 6.479e-05, IC Loss: 4.202e-05, BC Loss: 1.298e-05, V: 0.100
[Adam]: Iteration 0, Total loss: 5.345e+00, PDE Loss: 5.345e+00, IC Loss: 1.940e-05, BC Loss: 7.541e-06, V: 3.422
[Adam]: Iteration 1000, Total loss: 1.716e-01, PDE Loss: 6.613e-02, IC Loss: 8.874e-02, BC Loss: 1.672e-02, V: 3.422
[Adam]: Iteration 2000, Total loss: 7.963e-03, PDE Loss: 3.976e-03, IC Loss: 1.858e-03, BC Loss: 2.129e-03, V: 3.422
[Adam]: Iteration 3000, Total loss: 2.222e-03, PDE Loss: 1.715e-03, IC Loss: 3.218e-04, BC Loss: 1.854e-04, V: 3.422
[Adam]: Iteration 0, Total loss: 5.475e+00, PDE Loss: 5.475e+00, IC Loss: 2.011e-04, BC Loss: 9.638e-05, V: 6.744
[Adam]: Iteration 1000, Total loss: 1.306e-01, PDE Loss: 2.897e-02, IC Loss: 4.110e-02, BC Loss: 6.054e-02, V: 6.744
[Adam]: Iteration 2000, Total loss: 7.532e-02, PDE Loss: 2.236e-02, IC Loss: 1.839e-02, BC Loss: 3.457e-02, V: 6.744
[Adam]: Iteration 3000, Total loss: 3.200e-03, PDE Loss: 2.336e-03, IC Loss: 2.718e-04, BC Loss: 5.926e-04, V: 6.744
[Adam]: Iteration 0, Total loss: 5.466e+00, PDE Loss: 5.466e+00, IC Loss: 8.657e-05, BC Loss: 1.457e-04, V: 10.067
[Adam]: Iteration 1000, Total loss: 1.029e-01, PDE Loss: 2.051e-02, IC Loss: 2.438e-02, BC Loss: 5.801e-02, V: 10.067
[Adam]: Iteration 2000, Total loss: 4.713e-02, PDE Loss: 9.314e-03, IC Loss: 7.615e-03, BC Loss: 3.020e-02, V: 10.067
[Adam]: Iteration 3000, Total loss: 3.758e-03, PDE Loss: 1.290e-03, IC Loss: 3.797e-04, BC Loss: 2.087e-03, V: 10.067
[Adam]: Iteration 0, Total loss: 5.410e+00, PDE Loss: 5.409e+00, IC Loss: 7.612e-05, BC Loss: 3.524e-04, V: 13.389
[Adam]: Iteration 1000, Total loss: 1.634e-02, PDE Loss: 3.634e-03, IC Loss: 2.760e-03, BC Loss: 9.944e-03, V: 13.389
[Adam]: Iteration 2000, Total loss: 1.230e-03, PDE Loss: 6.086e-04, IC Loss: 6.559e-05, BC Loss: 5.556e-04, V: 13.389
[Adam]: Iteration 3000, Total loss: 5.804e-04, PDE Loss: 3.198e-04, IC Loss: 1.973e-05, BC Loss: 2.409e-04, V: 13.389
[Adam]: Iteration 0, Total loss: 5.447e+00, PDE Loss: 5.447e+00, IC Loss: 9.844e-06, BC Loss: 1.176e-04, V: 16.711
[Adam]: Iteration 1000, Total loss: 4.146e-02, PDE Loss: 4.455e-03, IC Loss: 4.686e-03, BC Loss: 3.232e-02, V: 16.711
[Adam]: Iteration 2000, Total loss: 4.123e-03, PDE Loss: 1.440e-03, IC Loss: 5.180e-04, BC Loss: 2.165e-03, V: 16.711
[Adam]: Iteration 3000, Total loss: 4.319e-04, PDE Loss: 2.616e-04, IC Loss: 7.693e-06, BC Loss: 1.626e-04, V: 16.711
[Adam]: Iteration 0, Total loss: 5.474e+00, PDE Loss: 5.474e+00, IC Loss: 6.313e-06, BC Loss: 6.693e-05, V: 20.033
[Adam]: Iteration 1000, Total loss: 1.209e-03, PDE Loss: 6.262e-04, IC Loss: 6.659e-05, BC Loss: 5.158e-04, V: 20.033
[Adam]: Iteration 2000, Total loss: 3.664e-04, PDE Loss: 2.659e-04, IC Loss: 6.209e-06, BC Loss: 9.426e-05, V: 20.033
[Adam]: Iteration 3000, Total loss: 2.003e-04, PDE Loss: 1.472e-04, IC Loss: 4.689e-06, BC Loss: 4.846e-05, V: 20.033
[Adam]: Iteration 0, Total loss: 5.451e+00, PDE Loss: 5.451e+00, IC Loss: 4.691e-06, BC Loss: 3.857e-05, V: 23.356
[Adam]: Iteration 1000, Total loss: 5.856e-03, PDE Loss: 7.587e-04, IC Loss: 3.596e-04, BC Loss: 4.738e-03, V: 23.356
[Adam]: Iteration 2000, Total loss: 1.853e-03, PDE Loss: 3.224e-04, IC Loss: 8.234e-05, BC Loss: 1.448e-03, V: 23.356
[Adam]: Iteration 3000, Total loss: 7.374e-04, PDE Loss: 1.696e-04, IC Loss: 3.272e-05, BC Loss: 5.352e-04, V: 23.356
[Adam]: Iteration 0, Total loss: 5.275e+00, PDE Loss: 5.275e+00, IC Loss: 1.687e-05, BC Loss: 2.163e-04, V: 26.678
[Adam]: Iteration 1000, Total loss: 2.428e-02, PDE Loss: 1.230e-03, IC Loss: 1.266e-03, BC Loss: 2.178e-02, V: 26.678
[Adam]: Iteration 2000, Total loss: 2.189e-02, PDE Loss: 1.109e-03, IC Loss: 1.176e-03, BC Loss: 1.960e-02, V: 26.678
[Adam]: Iteration 3000, Total loss: 1.484e-02, PDE Loss: 8.925e-04, IC Loss: 8.341e-04, BC Loss: 1.312e-02, V: 26.678
[Adam]: Iteration 0, Total loss: 4.137e+00, PDE Loss: 4.135e+00, IC Loss: 1.126e-04, BC Loss: 1.700e-03, V: 30.000
[Adam]: Iteration 1000, Total loss: 4.619e-03, PDE Loss: 8.574e-04, IC Loss: 2.461e-04, BC Loss: 3.516e-03, V: 30.000
[Adam]: Iteration 2000, Total loss: 4.953e-03, PDE Loss: 3.566e-03, IC Loss: 2.553e-04, BC Loss: 1.131e-03, V: 30.000
[Adam]: Iteration 3000, Total loss: 7.563e-04, PDE Loss: 1.865e-04, IC Loss: 3.724e-05, BC Loss: 5.326e-04, V: 30.000
</pre></div>
</div>
<img alt="../_images/65242c04b2d63db35bbe3648e9c0d291ea76bf5003d4ac7f3276dfa042f8dde9.png" src="../_images/65242c04b2d63db35bbe3648e9c0d291ea76bf5003d4ac7f3276dfa042f8dde9.png" />
</div>
</div>
<p>Leveraging transfer learning in such ways can drastically increase the model’s ability to learn.</p>
</section>
<section id="sampling-strategy">
<h2>Sampling Strategy<a class="headerlink" href="#sampling-strategy" title="Link to this heading">#</a></h2>
<p>It has been studied that the sampling strategy plays an important role in training PINNs. The samples used for the calculation of PDE residuals can be sampled non-adaptive or adaptive. So far we have only handled non-adaptive samplings, more specifically uniform grid grid and random samples. Non-adaptive methods are simple to implement, but can lack the training accuracy for complex problems.</p>
<p>Strategies such as residual-based adaptive refining (RAR) or gradient-based adaptive refining (GAR) can significantly increase the accuracy especially when the number of residual points are small. Also the problems with steep gradients are better trained using with adaptive sampling methods, as the model can resample more points of the region with steep gradients.</p>
<p>Lets investigate some these using the diffusion equation:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial u}{\partial t} - \frac{\partial^2 u}{\partial x^2} + e^{-t}(\sin(\pi x) - \pi^2\sin(\pi x)) = 0\]</div>
<div class="math notranslate nohighlight">
\[u(x, 0) = sin(\pi x)\quad x\in[-1, 1]\]</div>
<div class="math notranslate nohighlight">
\[u(-1, t) = u(1, t) = 0, \quad t\in[0,1]\]</div>
<p>exact solution is:</p>
<div class="math notranslate nohighlight">
\[u(x, t) = \sin(\pi x)e^{-t}\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u_diffusion</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">)</span>

<span class="c1"># Plot the analytical solution for the diffusion equation</span>
<span class="n">x_lin</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># x grid</span>
<span class="n">t_lin</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># t grid</span>
<span class="n">x_grid</span><span class="p">,</span> <span class="n">t_grid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_lin</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">t_lin</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
<span class="n">x_grid_flat</span> <span class="o">=</span> <span class="n">x_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">t_grid_flat</span> <span class="o">=</span> <span class="n">t_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">u_analytical</span> <span class="o">=</span> <span class="n">u_diffusion</span><span class="p">(</span><span class="n">x_grid_flat</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">t_grid_flat</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">u_analytical</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;rainbow&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.colorbar.Colorbar at 0x74399945e620&gt;
</pre></div>
</div>
<img alt="../_images/60045865c2bc0de1ef39f4556bc3e5823923f5a066d57c8316cd7d28ac01b237.png" src="../_images/60045865c2bc0de1ef39f4556bc3e5823923f5a066d57c8316cd7d28ac01b237.png" />
</div>
</div>
<p>Here we are introducing some sampling methods, uniform grid latih hypercube and random samples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats.qmc</span><span class="w"> </span><span class="kn">import</span> <span class="n">LatinHypercube</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generate_grid_sample</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">spans</span><span class="p">):</span>

    <span class="n">n_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spans</span><span class="p">)</span>
    <span class="n">nums_each_dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_samples</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">n_dims</span><span class="p">)))</span>  <span class="c1"># Calculate points per dimension</span>
    
    <span class="n">grids</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">span</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">span</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nums_each_dim</span><span class="p">)</span> <span class="k">for</span> <span class="n">span</span> <span class="ow">in</span> <span class="n">spans</span><span class="p">]</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">grids</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
    <span class="n">grid_points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">g</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grid</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Take only the first n_samples points</span>
    <span class="k">return</span> <span class="n">grid_points</span><span class="p">[:</span><span class="n">n_samples</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generate_lhs_sample</span><span class="p">(</span><span class="n">nums_each_dim</span><span class="p">,</span> <span class="n">spans</span><span class="p">):</span>

    <span class="n">lhs</span> <span class="o">=</span> <span class="n">LatinHypercube</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">spans</span><span class="p">))</span>
    <span class="n">lhs_samples</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nums_each_dim</span><span class="p">)</span>  <span class="c1"># shape: (nums_each_dim, d)</span>
    <span class="c1"># Scale each column to the corresponding span</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">span</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spans</span><span class="p">):</span>
        <span class="n">lhs_samples</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">span</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">span</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">span</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">lhs_samples</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">lhs_samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generate_random_sample</span><span class="p">(</span><span class="n">nums_each_dim</span><span class="p">,</span> <span class="n">spans</span><span class="p">):</span>

    <span class="c1"># Generate a (nums_each_dim, len(spans)) tensor of random numbers in [0, 1)</span>
    <span class="n">rand</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">nums_each_dim</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spans</span><span class="p">))</span>
    <span class="c1"># Scale each column to the corresponding span</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">span</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spans</span><span class="p">):</span>
        <span class="n">rand</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">span</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">span</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">span</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">rand</span>

<span class="c1"># generate data using the three methods</span>
<span class="n">num_points</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">spans</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>  <span class="c1"># spans for x and t</span>
<span class="n">flat_grid_sample</span> <span class="o">=</span> <span class="n">generate_grid_sample</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">spans</span><span class="p">)</span>
<span class="n">lhs_sample</span> <span class="o">=</span> <span class="n">generate_lhs_sample</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">spans</span><span class="p">)</span>
<span class="n">random_sample</span> <span class="o">=</span> <span class="n">generate_random_sample</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">spans</span><span class="p">)</span>

<span class="c1"># Plot the samples</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">flat_grid_sample</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">flat_grid_sample</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Uniform Grid Sample&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Uniform Grid Sample&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lhs_sample</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">lhs_sample</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;LHS Sample&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Latin Hypercube Sample&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">random_sample</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">random_sample</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random Sample&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Random Sample&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0a8c472b3c8002be7181e37c73e1832c506fe3db42d66775ef7a409935d34bb8.png" src="../_images/0a8c472b3c8002be7181e37c73e1832c506fe3db42d66775ef7a409935d34bb8.png" />
</div>
</div>
<p>Then we can build the PINN model for the diffusion equation as before. Here I’ve already implemented some extra class methods for sampling strategies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">pinn_diffusion</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">net_u</span><span class="p">,</span> <span class="n">loss_fn</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(),</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">pinn_diffusion</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net_u</span> <span class="o">=</span> <span class="n">net_u</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_points</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize adaptive points</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span> <span class="o">=</span> <span class="n">loss_fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">net_u_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_u</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">u</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">pde_residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_u_forward</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">u_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">u_xx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u_x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u_x</span><span class="p">),</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">u_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">pde_residual</span> <span class="o">=</span> <span class="n">u_t</span> <span class="o">-</span> <span class="n">u_xx</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pde_residual</span>
    
    <span class="c1"># Calculates the loss for the PDE</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loss_pde</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">pde_residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pde_residual</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">pde_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">pde_residual</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pde_residual</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pde_loss</span>
    
    <span class="c1"># Calculates the loss for the initial condition u(x, 0) = sin(pi * x) + 1/2 * sin(4 * pi * x)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loss_ic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_u_forward</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="c1"># u_real = torch.sin(np.pi * x) + 1/2 * torch.sin(4 * np.pi * x)</span>
        <span class="n">u_real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">ic_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">u_real</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ic_loss</span>

    <span class="c1"># Calculates the loss for the boundary conditions u(0, t) = u(1, t) = 0</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loss_bc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_u_forward</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">bc_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">bc_loss</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">pinn_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

        <span class="n">x_dom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t_dom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x_ic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t_ic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x_l_bc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_l_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t_l_bc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_l_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x_r_bc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_r_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t_r_bc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_r_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Calculate losses</span>
        <span class="n">pde_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_pde</span><span class="p">(</span><span class="n">x_dom</span><span class="p">,</span> <span class="n">t_dom</span><span class="p">)</span>
        <span class="n">ic_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_ic</span><span class="p">(</span><span class="n">x_ic</span><span class="p">,</span> <span class="n">t_ic</span><span class="p">)</span>
        <span class="n">bc_l_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_bc</span><span class="p">(</span><span class="n">x_l_bc</span><span class="p">,</span> <span class="n">t_l_bc</span><span class="p">)</span>
        <span class="n">bc_r_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_bc</span><span class="p">(</span><span class="n">x_r_bc</span><span class="p">,</span> <span class="n">t_r_bc</span><span class="p">)</span>

        <span class="n">total_loss</span> <span class="o">=</span> <span class="n">pde_loss</span> <span class="o">+</span> <span class="n">ic_loss</span> <span class="o">+</span> <span class="n">bc_l_loss</span> <span class="o">+</span> <span class="n">bc_r_loss</span>
        <span class="n">total_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span> <span class="c1"># backpropagate the total loss</span>

        <span class="c1"># log the losses </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer_name</span><span class="si">}</span><span class="s1">]: Iteration </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">iter</span><span class="si">}</span><span class="s1">, Total loss: </span><span class="si">{</span><span class="n">total_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1">, PDE Loss: </span><span class="si">{</span><span class="n">pde_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1">, IC Loss: </span><span class="si">{</span><span class="n">ic_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1">, BC Left Loss: </span><span class="si">{</span><span class="n">bc_l_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1">, BC Right Loss: </span><span class="si">{</span><span class="n">bc_r_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">total_loss</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">train_net</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="p">,</span> <span class="n">bc_l_points</span><span class="p">,</span> <span class="n">bc_r_points</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">,</span> <span class="n">log_interval</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domain_points</span> <span class="o">=</span> <span class="n">domain_points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ic_points</span> <span class="o">=</span> <span class="n">ic_points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc_l_points</span> <span class="o">=</span> <span class="n">bc_l_points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bc_r_points</span> <span class="o">=</span> <span class="n">bc_r_points</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">net_u</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_interval</span> <span class="o">=</span> <span class="n">log_interval</span>
        <span class="k">if</span> <span class="n">optimizer</span> <span class="ow">is</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">LBFGS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_name</span> <span class="o">=</span> <span class="s1">&#39;LBFGS&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_u</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">max_eval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">tolerance_grad</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">tolerance_change</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">line_search_fn</span><span class="o">=</span><span class="s1">&#39;strong_wolfe&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pinn_loss</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_u</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer_name</span> <span class="o">=</span> <span class="s1">&#39;Adam&#39;</span>
            <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pinn_loss</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">adaptive_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_points</span><span class="p">,</span> <span class="n">base_grid_points</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="n">base_grid_x</span> <span class="o">=</span> <span class="n">base_grid_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">base_grid_t</span> <span class="o">=</span> <span class="n">base_grid_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;gar&#39;</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_u_forward</span><span class="p">(</span><span class="n">base_grid_x</span><span class="p">,</span> <span class="n">base_grid_t</span><span class="p">)</span>

            <span class="c1"># calculate gradients to see the steepest prediction points</span>
            <span class="n">u_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">base_grid_x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">u_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">base_grid_t</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">idx_u_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">u_x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span> <span class="n">num_points</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">idx_u_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">u_t</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span> <span class="n">num_points</span><span class="p">)</span>

            <span class="n">idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">idx_u_x</span><span class="p">,</span> <span class="n">idx_u_t</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>  <span class="c1"># Ensure unique indice</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;rar&#39;</span><span class="p">:</span>
            <span class="n">pde_residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pde_residual</span><span class="p">(</span><span class="n">base_grid_x</span><span class="p">,</span> <span class="n">base_grid_t</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">pde_residual</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span> <span class="n">num_points</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_points</span> <span class="o">=</span> <span class="n">base_grid_points</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_points</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net_u</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_u_forward</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_x</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">num_t</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">net_u</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="c1"># Prepare testing grid</span>
        <span class="n">x_test</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_x</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">t_test</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_t</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">x_grid</span><span class="p">,</span> <span class="n">t_grid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">t_test</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
        <span class="n">x_grid_flat</span> <span class="o">=</span> <span class="n">x_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">t_grid_flat</span> <span class="o">=</span> <span class="n">t_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Predict using the trained model</span>
        <span class="n">u_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_grid_flat</span><span class="p">,</span> <span class="n">t_grid_flat</span><span class="p">)</span>
        <span class="c1"># Analytical solution</span>
        <span class="n">ref_sol</span> <span class="o">=</span> <span class="n">u_diffusion</span><span class="p">(</span><span class="n">x_grid_flat</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">t_grid_flat</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_x</span><span class="p">,</span> <span class="n">num_t</span><span class="p">)</span>

        <span class="c1"># Reshape for comparison</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">u_pred</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_x</span><span class="p">,</span> <span class="n">num_t</span><span class="p">)</span>

        <span class="c1"># Calculate errors</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sol</span> <span class="o">-</span> <span class="n">ref_sol</span><span class="p">)</span>

        <span class="c1"># calculate L2 relative error</span>
        <span class="n">L2_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ref_sol</span><span class="p">)</span>
        <span class="n">L2_rel_error</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">/</span> <span class="n">L2_norm</span>
        <span class="n">mean_relative_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">L2_rel_error</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean Relative Error: </span><span class="si">{</span><span class="n">mean_relative_error</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># accuracy 1 - normalized RMSE</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sol</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">L</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;rainbow&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PINN Prediction&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ref_sol</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">L</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;rainbow&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Reference Solution&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">L</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Absolute Error, Accuracy: </span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domain_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">domain_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;steelblue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;collcations&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adaptive_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;yellowgreen&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;adaptive points&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_l_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_l_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bc_r_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bc_r_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ic_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ic_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;t&quot;</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;x&quot;</span> <span class="o">+</span> <span class="s1">&#39;m&#39;</span><span class="p">,)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Sampling Points&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We define a Sampler class, to hold the functions for sampling. We can use this class later for sampling the residual, bc and ic points during training.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Sampler</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spans</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spans</span> <span class="o">=</span> <span class="n">spans</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_dom</span><span class="p">,</span> <span class="n">num_ic</span><span class="p">,</span> <span class="n">num_bc</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>

        <span class="n">dom_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_domain_points</span><span class="p">(</span><span class="n">num_dom</span><span class="p">,</span> <span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="p">)</span>
        <span class="n">ic_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_ic_points</span><span class="p">(</span><span class="n">num_ic</span><span class="p">,</span> <span class="n">method</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">bc_left_points</span><span class="p">,</span> <span class="n">bc_right_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_bc_points</span><span class="p">(</span><span class="n">num_bc</span><span class="p">,</span> <span class="n">method</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">dom_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="p">,</span> <span class="n">bc_left_points</span><span class="p">,</span> <span class="n">bc_right_points</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">sample_domain_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_points</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>

        <span class="c1"># remove the first and last points from the spans to avoid boundary points</span>
        <span class="n">spans</span> <span class="o">=</span> <span class="p">[(</span><span class="n">span</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="n">span</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1e-5</span><span class="p">)</span> <span class="k">for</span> <span class="n">span</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">generate_grid_sample</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">spans</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;lhs&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">generate_lhs_sample</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">spans</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">generate_random_sample</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">spans</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Method must be &#39;grid&#39;, &#39;lhs&#39;, or &#39;random&#39;.&quot;</span><span class="p">)</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">sample_ic_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_points</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">num_points</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;lhs&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">generate_lhs_sample</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])])</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">generate_random_sample</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])])</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Method must be &#39;grid&#39;, &#39;lhs&#39;, or &#39;random&#39;.&quot;</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">sample_bc_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_points</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;grid&#39;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">num_points</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">x_left</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">x_right</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">bc_left_points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x_left</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">bc_right_points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x_right</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">bc_left_points</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">bc_right_points</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;lhs&#39;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">generate_lhs_sample</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])])</span>
            <span class="n">x_left</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">x_right</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">bc_left_points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x_left</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">bc_right_points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x_right</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">bc_left_points</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">bc_right_points</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">generate_random_sample</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])])</span>
            <span class="n">x_left</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">x_right</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">bc_left_points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x_left</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">bc_right_points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x_right</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">bc_left_points</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">bc_right_points</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>


<span class="n">sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">(</span><span class="n">spans</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
<span class="n">dom_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="p">,</span> <span class="n">bc_left_points</span><span class="p">,</span> <span class="n">bc_right_points</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_dom</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">num_ic</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">num_bc</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dom_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">dom_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sampled Domain Points&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ic_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ic_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Initial Condition Points&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bc_left_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bc_left_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Points (Left)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bc_right_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bc_right_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary Points (Right)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sampled Domain, Boundary, and Initial Condition Points&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x74399974a560&gt;
</pre></div>
</div>
<img alt="../_images/0a2d1cd3500154061464df14a5453f05d557094ca181ccfa66331d0da8fe8b8c.png" src="../_images/0a2d1cd3500154061464df14a5453f05d557094ca181ccfa66331d0da8fe8b8c.png" />
</div>
</div>
<p>First lets train the model with fixed samples. Change the sampling_methods in the following cell and observe the difference. There is minor difference as the problem is a rather easier one.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>  <span class="c1"># Set seed for reproducibility</span>

<span class="c1"># simple pinn architecture</span>
<span class="n">arch</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Input layer, hidden layers, output layer</span>
<span class="n">act</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span>  <span class="c1"># Activation function</span>
<span class="n">net_u</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">act</span><span class="p">)</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="c1"># device = torch.device(&#39;mps&#39;)</span>
<span class="n">model_diffusion</span> <span class="o">=</span> <span class="n">pinn_diffusion</span><span class="p">(</span><span class="n">net_u</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>


<span class="c1"># create the sampler for the problem</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">(</span><span class="n">spans</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

<span class="n">epochs</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="c1"># uncommet these and then try the code to see the difference</span>

<span class="c1"># sampling_methods = [&#39;grid&#39;, &#39;grid&#39;, &#39;grid&#39;]  </span>
<span class="c1"># sampling_methods = [&#39;lhs&#39;, &#39;grid&#39;, &#39;grid&#39;]  </span>
<span class="n">sampling_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">]</span>

<span class="n">num_dom</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># Number of domain points</span>
<span class="n">num_ic</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># Number of initial condition points</span>
<span class="n">num_bc</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Number of boundary condition points</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span>  <span class="c1"># Optimizer to use</span>

<span class="n">dom_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="p">,</span> <span class="n">bc_left_points</span><span class="p">,</span> <span class="n">bc_right_points</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_dom</span><span class="o">=</span><span class="n">num_dom</span><span class="p">,</span> <span class="n">num_ic</span><span class="o">=</span><span class="n">num_ic</span><span class="p">,</span> <span class="n">num_bc</span><span class="o">=</span><span class="n">num_bc</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">sampling_methods</span><span class="p">)</span>

<span class="n">model_diffusion</span><span class="o">.</span><span class="n">train_net</span><span class="p">(</span><span class="n">dom_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="p">,</span> <span class="n">bc_left_points</span><span class="p">,</span> <span class="n">bc_right_points</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">log_interval</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">model_diffusion</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">num_x</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_t</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Adam]: Iteration 0, Total loss: 1.396e+01, PDE Loss: 1.349e+01, IC Loss: 4.386e-01, BC Left Loss: 2.891e-03, BC Right Loss: 2.574e-02
[Adam]: Iteration 1000, Total loss: 2.123e-03, PDE Loss: 1.053e-03, IC Loss: 3.914e-04, BC Left Loss: 5.532e-04, BC Right Loss: 1.254e-04
[Adam]: Iteration 2000, Total loss: 3.298e-04, PDE Loss: 2.275e-04, IC Loss: 1.283e-05, BC Left Loss: 7.468e-05, BC Right Loss: 1.478e-05
[Adam]: Iteration 3000, Total loss: 1.492e-04, PDE Loss: 1.268e-04, IC Loss: 2.031e-06, BC Left Loss: 1.439e-05, BC Right Loss: 5.936e-06
[Adam]: Iteration 4000, Total loss: 4.250e-05, PDE Loss: 2.997e-05, IC Loss: 3.888e-07, BC Left Loss: 7.551e-06, BC Right Loss: 4.591e-06
[Adam]: Iteration 5000, Total loss: 2.093e-05, PDE Loss: 1.100e-05, IC Loss: 5.570e-08, BC Left Loss: 6.360e-06, BC Right Loss: 3.520e-06
[Adam]: Iteration 6000, Total loss: 1.234e-05, PDE Loss: 4.708e-06, IC Loss: 2.705e-07, BC Left Loss: 5.493e-06, BC Right Loss: 1.873e-06
[Adam]: Iteration 7000, Total loss: 6.631e-06, PDE Loss: 9.020e-07, IC Loss: 2.266e-07, BC Left Loss: 4.479e-06, BC Right Loss: 1.023e-06
[Adam]: Iteration 8000, Total loss: 4.931e-04, PDE Loss: 3.986e-04, IC Loss: 1.996e-05, BC Left Loss: 5.685e-05, BC Right Loss: 1.771e-05
[Adam]: Iteration 9000, Total loss: 1.163e-03, PDE Loss: 8.440e-04, IC Loss: 6.467e-05, BC Left Loss: 1.253e-04, BC Right Loss: 1.293e-04
Mean Relative Error: 0.0003
</pre></div>
</div>
<img alt="../_images/5d5b2f9c8a1499337f0ba2cab463535d7beaea4cb619f1bb0753a2224dc51ecf.png" src="../_images/5d5b2f9c8a1499337f0ba2cab463535d7beaea4cb619f1bb0753a2224dc51ecf.png" />
</div>
</div>
<p>Now we use adaptive sampling. We sample 5 new points each 1000 epochs, and train for 10000 epochs in total.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># simple pinn architecture</span>
<span class="n">arch</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Input layer, hidden layers, output layer</span>
<span class="n">act</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span>  <span class="c1"># Activation function</span>
<span class="n">net_u</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">act</span><span class="p">)</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<span class="c1"># device = torch.device(&#39;mps&#39;)</span>
<span class="n">model_diffusion</span> <span class="o">=</span> <span class="n">pinn_diffusion</span><span class="p">(</span><span class="n">net_u</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># create the sampler for the problem</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">(</span><span class="n">spans</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

<span class="n">epochs</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="n">sampling_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">]</span>

<span class="n">num_dom</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># Number of domain points</span>
<span class="n">num_ic</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># Number of initial condition points</span>
<span class="n">num_bc</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Number of boundary condition points</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span>  <span class="c1"># Optimizer to use</span>
<span class="n">RESAMPLE_FREQUENCY</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Resample every 1000 epochs</span>

<span class="c1"># number of base points to evaluate the residual or gradients and then use them for adaptive sampling</span>
<span class="n">NUM_BASE_POINTS</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">NUM_ADAPTIVE_POINTS</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">base_points</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample_domain_points</span><span class="p">(</span><span class="n">num_points</span><span class="o">=</span><span class="n">NUM_BASE_POINTS</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;grid&#39;</span><span class="p">)</span>
<span class="c1"># a loop that resamples the points every RESAMPLE_FREQUENCY epochs but in total still train for 10000 epochs</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">RESAMPLE_FREQUENCY</span><span class="p">):</span>
    <span class="c1"># Sample new points</span>
    <span class="n">dom_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="p">,</span> <span class="n">bc_left_points</span><span class="p">,</span> <span class="n">bc_right_points</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_dom</span><span class="o">=</span><span class="n">num_dom</span><span class="p">,</span> <span class="n">num_ic</span><span class="o">=</span><span class="n">num_ic</span><span class="p">,</span> <span class="n">num_bc</span><span class="o">=</span><span class="n">num_bc</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">sampling_methods</span><span class="p">)</span>
    
    <span class="c1"># Use adaptive sampling to select the most informative points</span>
    <span class="c1"># adaptive_points = model_diffusion.adaptive_sampling(num_points=NUM_ADAPTIVE_POINTS, base_grid_points=base_points, method=&#39;gar&#39;)</span>
    <span class="n">adaptive_points</span> <span class="o">=</span> <span class="n">model_diffusion</span><span class="o">.</span><span class="n">adaptive_sampling</span><span class="p">(</span><span class="n">num_points</span><span class="o">=</span><span class="n">NUM_ADAPTIVE_POINTS</span><span class="p">,</span> <span class="n">base_grid_points</span><span class="o">=</span><span class="n">base_points</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;rar&#39;</span><span class="p">)</span>

    <span class="c1"># Combine the adaptive points with the sampled points</span>
    <span class="n">dom_points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">dom_points</span><span class="p">,</span> <span class="n">adaptive_points</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Train the model on the sampled points</span>
    <span class="n">model_diffusion</span><span class="o">.</span><span class="n">train_net</span><span class="p">(</span><span class="n">dom_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="p">,</span> <span class="n">bc_left_points</span><span class="p">,</span> <span class="n">bc_right_points</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">RESAMPLE_FREQUENCY</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">log_interval</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

    <span class="n">model_diffusion</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">num_x</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_t</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Adam]: Iteration 0, Total loss: 3.158e+01, PDE Loss: 3.106e+01, IC Loss: 4.500e-01, BC Left Loss: 3.132e-02, BC Right Loss: 4.620e-02
Mean Relative Error: 0.0004
[Adam]: Iteration 0, Total loss: 7.348e-01, PDE Loss: 7.290e-01, IC Loss: 4.878e-03, BC Left Loss: 2.440e-04, BC Right Loss: 7.435e-04
Mean Relative Error: 0.0002
[Adam]: Iteration 0, Total loss: 1.152e+00, PDE Loss: 1.151e+00, IC Loss: 2.232e-04, BC Left Loss: 2.748e-05, BC Right Loss: 4.522e-05
Mean Relative Error: 0.0002
[Adam]: Iteration 0, Total loss: 1.487e+00, PDE Loss: 1.487e+00, IC Loss: 9.099e-06, BC Left Loss: 6.313e-05, BC Right Loss: 1.059e-05
Mean Relative Error: 0.0010
[Adam]: Iteration 0, Total loss: 1.248e+00, PDE Loss: 1.248e+00, IC Loss: 6.321e-05, BC Left Loss: 1.377e-05, BC Right Loss: 7.297e-06
Mean Relative Error: 0.0002
[Adam]: Iteration 0, Total loss: 3.397e-01, PDE Loss: 3.397e-01, IC Loss: 1.044e-06, BC Left Loss: 2.814e-06, BC Right Loss: 2.139e-05
Mean Relative Error: 0.0001
[Adam]: Iteration 0, Total loss: 3.085e-01, PDE Loss: 3.085e-01, IC Loss: 1.360e-06, BC Left Loss: 3.635e-06, BC Right Loss: 5.915e-06
Mean Relative Error: 0.0002
[Adam]: Iteration 0, Total loss: 2.410e-01, PDE Loss: 2.410e-01, IC Loss: 2.739e-07, BC Left Loss: 2.784e-06, BC Right Loss: 5.118e-06
Mean Relative Error: 0.0001
[Adam]: Iteration 0, Total loss: 1.226e-01, PDE Loss: 1.225e-01, IC Loss: 2.405e-07, BC Left Loss: 2.002e-06, BC Right Loss: 6.640e-06
Mean Relative Error: 0.0001
[Adam]: Iteration 0, Total loss: 1.257e-01, PDE Loss: 1.257e-01, IC Loss: 2.177e-07, BC Left Loss: 2.947e-06, BC Right Loss: 4.019e-06
Mean Relative Error: 0.0001
</pre></div>
</div>
<img alt="../_images/b5e581866bec3406adead8909b99efb4f59d8f83a10168b7efec9ca4f1e62bf1.png" src="../_images/b5e581866bec3406adead8909b99efb4f59d8f83a10168b7efec9ca4f1e62bf1.png" />
<img alt="../_images/5203a7fd6d3f88b3a77399546ee2bc8d827b97a761681004d8223ad03656c121.png" src="../_images/5203a7fd6d3f88b3a77399546ee2bc8d827b97a761681004d8223ad03656c121.png" />
<img alt="../_images/15a3c32ede4c2f01ee03c4dfecc96e59df2b7bab886e19e0f82b5b965dc43972.png" src="../_images/15a3c32ede4c2f01ee03c4dfecc96e59df2b7bab886e19e0f82b5b965dc43972.png" />
<img alt="../_images/09a13dbe582cce86a827ffefe8f6585deb810b39597ffc5e4fd563aab6b6e08a.png" src="../_images/09a13dbe582cce86a827ffefe8f6585deb810b39597ffc5e4fd563aab6b6e08a.png" />
<img alt="../_images/8d39c847c630baf1181ffea9855891476ba68912d43db0b5e73a1fab731e9bc0.png" src="../_images/8d39c847c630baf1181ffea9855891476ba68912d43db0b5e73a1fab731e9bc0.png" />
<img alt="../_images/8c17bec07044d022d1764645083bda83ca8bd735ffa01250f58d2b30eebe61a6.png" src="../_images/8c17bec07044d022d1764645083bda83ca8bd735ffa01250f58d2b30eebe61a6.png" />
<img alt="../_images/35346e3f16b2ef90f80f6a18356bcba7d3b6fb5352dc60b83b2982817b52b5dc.png" src="../_images/35346e3f16b2ef90f80f6a18356bcba7d3b6fb5352dc60b83b2982817b52b5dc.png" />
<img alt="../_images/dd1ee2b71e884a267dcc12d5edbfa3697e4794430b645a6ed7c068a23ecd1f36.png" src="../_images/dd1ee2b71e884a267dcc12d5edbfa3697e4794430b645a6ed7c068a23ecd1f36.png" />
<img alt="../_images/1d63bced34a740a072e0f6391a8d3ae85a841b94c30c03f409b4706185366fef.png" src="../_images/1d63bced34a740a072e0f6391a8d3ae85a841b94c30c03f409b4706185366fef.png" />
<img alt="../_images/313421bf01904edb41200b16fac5e40f9c8718dbf619f7f6a340f16f3daca976.png" src="../_images/313421bf01904edb41200b16fac5e40f9c8718dbf619f7f6a340f16f3daca976.png" />
</div>
</div>
<p>We see a slight increase in the accuracy of the model. Now lets check the last technique adaptive weights and try to implement all in a more difficult problem.</p>
</section>
<section id="adaptive-weights">
<h2>Adaptive Weights<a class="headerlink" href="#adaptive-weights" title="Link to this heading">#</a></h2>
<p>We already know the assigning proper weights for the losses are very important to adjust the scales of the losses. Otherwise since the scales of the losses will be different the problem will be very hard to optimize. Methods such as non-dimensionalizing helps with getting the losses into similar scales, but for complicated problems its not always the case, and manually finding the best weights might be very challenging. To overcome this issue some self adaptive loss balancing algorithms have been developed. Mainly there are two types of self balancing algorithms, gradient norm-based and Neural Tangent Kernel (NTK) based.</p>
<ol class="arabic">
<li><p><strong>Gradient Norm (GN) based:</strong> This method balances the losses by ensuring that the gradient magnitudes of different loss components are similar. The idea is that if one loss term has much larger gradients than others, it will dominate the training process. The gradient norm method calculates the L2 norm of gradients for each loss component and adjusts the weights to balance these gradient magnitudes. The weights are updated dynamically during training:</p>
<div class="math notranslate nohighlight">
\[w_i^{(k+1)} = w_i^{(k)} \cdot \frac{\bar{G}}{G_i^{(k)}}\]</div>
<p>where <span class="math notranslate nohighlight">\(w_i^{(k)}\)</span> is the weight for loss component <span class="math notranslate nohighlight">\(i\)</span> at iteration <span class="math notranslate nohighlight">\(k\)</span>, <span class="math notranslate nohighlight">\(G_i^{(k)}\)</span> is the gradient norm of loss <span class="math notranslate nohighlight">\(i\)</span>, and <span class="math notranslate nohighlight">\(\bar{G}\)</span> is the average gradient norm across all loss components.</p>
</li>
<li><p><strong>NTK based:</strong> The Neural Tangent Kernel approach uses the concept that the training dynamics of neural networks can be approximated by their tangent kernels. This method balances the losses by considering how each loss component affects the network’s learning dynamics. It computes the NTK for each loss term and adjusts weights to ensure balanced training across all physics constraints and boundary conditions. The NTK-based weights are computed as:</p>
<div class="math notranslate nohighlight">
\[w_i = \frac{1}{\text{trace}(K_i)}\]</div>
<p>where <span class="math notranslate nohighlight">\(K_i\)</span> is the NTK matrix for loss component <span class="math notranslate nohighlight">\(i\)</span>.</p>
</li>
</ol>
<p>We now consider the 1 dimensional wave equation:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial^2 u}{\partial t^2} - 4\frac{\partial^2 u}{\partial x^2} = 0\]</div>
<div class="math notranslate nohighlight">
\[u(0, t) = u(1, t) = 0, \quad t\in[0, 1]\]</div>
<div class="math notranslate nohighlight">
\[u(x, 0) = \sin(\pi x) + \frac{1}{2}\sin(4\pi x), \quad x\in[0,1]\]</div>
<div class="math notranslate nohighlight">
\[\frac{\partial u}{\partial t}(x, 0), \quad x\in[0,1]\]</div>
<p>The exact solution of this is:
$<span class="math notranslate nohighlight">\(u(x, t) = \sin(\pi x)\cos(2\pi t) + \frac{1}{2}\sin(4\pi x)\cos(8\pi t)\)</span>$</p>
<p>And below we create a PINN model with adaptive sampling and NTK based adaptive loss balancing method implemented.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u_real_wave</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PINN_wave</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">net_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">u</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">u_t_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_u</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">u_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">u_t</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">pde_residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_u</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">u_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">u_xx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u_x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u_x</span><span class="p">),</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">u_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">u_tt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u_t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u_t</span><span class="p">),</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">pde_residual</span> <span class="o">=</span> <span class="n">u_tt</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">u_xx</span>
        <span class="k">return</span> <span class="n">pde_residual</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ic_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">adaptive_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_points</span><span class="p">,</span> <span class="n">base_grid_points</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="n">base_grid_x</span> <span class="o">=</span> <span class="n">base_grid_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">base_grid_t</span> <span class="o">=</span> <span class="n">base_grid_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;gar&#39;</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_u</span><span class="p">(</span><span class="n">base_grid_x</span><span class="p">,</span> <span class="n">base_grid_t</span><span class="p">)</span>

            <span class="c1"># calculate gradients to see the steepest prediction points</span>
            <span class="n">u_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">base_grid_x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">u_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">base_grid_t</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">idx_u_x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">u_x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span> <span class="n">num_points</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">idx_u_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">u_t</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span> <span class="n">num_points</span><span class="p">)</span>

            <span class="n">idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">idx_u_x</span><span class="p">,</span> <span class="n">idx_u_t</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> 

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;rar&#39;</span><span class="p">:</span>
            <span class="n">pde_residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pde_residual</span><span class="p">(</span><span class="n">base_grid_x</span><span class="p">,</span> <span class="n">base_grid_t</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">pde_residual</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span> <span class="n">num_points</span><span class="p">)</span>
        
        <span class="n">adaptive_points</span> <span class="o">=</span> <span class="n">base_grid_points</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">adaptive_points</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_jacobian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Compute batched gradients w.r.t. all parameters except last layer</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">())[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">grad_outputs</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span> <span class="n">is_grads_batched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Concatenate  gradients into Jacobian matrix</span>
        <span class="n">jacobian</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">grad</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">grad</span> <span class="ow">in</span> <span class="n">gradients</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jacobian</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">calc_ntk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jacobian</span><span class="p">,</span> <span class="n">computation_type</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Neural Tangent Kernel metrics from Jacobian matrix.&quot;&quot;&quot;</span>
        
        <span class="c1"># Define computation methods using Einstein summation</span>
        <span class="n">ntk_operations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;full&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">jac</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Na,Ma-&gt;NM&#39;</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">jac</span><span class="p">),</span>  <span class="c1"># Full NTK matrix</span>
            <span class="s1">&#39;diag&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">jac</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Na,Na-&gt;N&#39;</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">jac</span><span class="p">),</span>   <span class="c1"># Diagonal elements</span>
            <span class="s1">&#39;trace&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">jac</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Na,Na-&gt;&#39;</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">jac</span><span class="p">)</span>    <span class="c1"># Trace (scalar)</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">computation_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ntk_operations</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Metric &quot;</span><span class="si">{</span><span class="n">computation_type</span><span class="si">}</span><span class="s1">&quot; not supported. &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;Choose from: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">ntk_operations</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ntk_operations</span><span class="p">[</span><span class="n">computation_type</span><span class="p">](</span><span class="n">jacobian</span><span class="p">)</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_adaptive_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loss_residuals</span><span class="p">,</span> <span class="n">sampling_strategy</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">return_info</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute NTK-based adaptive weights for loss terms.&quot;&quot;&quot;</span>
        <span class="n">traces</span><span class="p">,</span> <span class="n">jacs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">loss_residuals</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sampling_strategy</span> <span class="o">==</span> <span class="s2">&quot;random&quot;</span><span class="p">:</span> <span class="c1"># random-batch technique</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span> <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="k">else</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">jac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_jacobian</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="k">else</span> <span class="n">n</span>
            <span class="k">elif</span> <span class="n">sampling_strategy</span> <span class="o">==</span> <span class="s2">&quot;topres&quot;</span><span class="p">:</span>  <span class="c1"># compute the weight using the points with top residuals</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span> <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="k">else</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">jac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_jacobian</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="k">else</span> <span class="n">n</span>
            <span class="k">elif</span> <span class="n">sampling_strategy</span> <span class="o">==</span> <span class="s2">&quot;mini&quot;</span><span class="p">:</span> <span class="c1"># compute the weight using mini-batch technique</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
                    <span class="n">jac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_jacobian</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">])</span>
                    <span class="n">trace</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_ntk</span><span class="p">(</span><span class="n">jac</span><span class="p">,</span> <span class="n">computation_type</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">return_info</span><span class="p">:</span>
                    <span class="n">jacs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jac</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">sampling_strategy</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
                <span class="n">jac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_jacobian</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">n</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown sampling strategy: </span><span class="si">{</span><span class="n">sampling_strategy</span><span class="si">}</span><span class="s2">. Must be one of &#39;random&#39;, &#39;topres&#39;, &#39;mini&#39;, or &#39;full&#39;.&quot;</span><span class="p">)</span>

            <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_ntk</span><span class="p">(</span><span class="n">jac</span><span class="p">,</span> <span class="n">computation_type</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span> <span class="o">/</span> <span class="n">norm</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_info</span><span class="p">:</span>
                <span class="n">jacs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jac</span><span class="p">)</span>

        <span class="n">traces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">traces</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">traces</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">traces</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">jacs</span><span class="p">)</span> <span class="k">if</span> <span class="n">return_info</span> <span class="k">else</span> <span class="n">weights</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_u</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dom_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="p">,</span> <span class="n">bc_points</span><span class="p">,</span> <span class="n">adap_points</span><span class="p">,</span> <span class="n">num_x</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">num_t</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="c1"># Prepare testing grid</span>
        <span class="n">x_test</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_x</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">t_test</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_t</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">x_grid</span><span class="p">,</span> <span class="n">t_grid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">t_test</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">)</span>
        <span class="n">x_grid_flat</span> <span class="o">=</span> <span class="n">x_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">t_grid_flat</span> <span class="o">=</span> <span class="n">t_grid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Predict using the trained model</span>
        <span class="n">u_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_grid_flat</span><span class="p">,</span> <span class="n">t_grid_flat</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_x</span><span class="p">,</span> <span class="n">num_t</span><span class="p">)</span>
        <span class="c1"># Analytical solution</span>
        <span class="c1"># u_analytical = u_wave(x_grid_flat.cpu().numpy(), t_grid_flat.cpu().numpy()).reshape(num_x, num_t)</span>
        <span class="n">u_real</span> <span class="o">=</span> <span class="n">u_real_wave</span><span class="p">(</span><span class="n">x_grid_flat</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">t_grid_flat</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_x</span><span class="p">,</span> <span class="n">num_t</span><span class="p">)</span>

        <span class="c1"># Calculate errors</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">u_pred</span> <span class="o">-</span> <span class="n">u_real</span><span class="p">)</span>
        <span class="c1">#Calculate L2 normalized relative error</span>
        <span class="n">L2_relative_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u_real</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;L2 Normalized Relative Error: </span><span class="si">{</span><span class="n">L2_relative_error</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Calculate accuracy as 1 - normalized RMSE</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">u_pred</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;rainbow&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PINN Prediction&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">u_real</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;rainbow&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Reference Solution&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Absolute Error, Accuracy: </span><span class="si">{</span><span class="n">acc</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dom_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">dom_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;steelblue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;collcations&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">adap_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">adap_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">adap_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;yellowgreen&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;adaptive points&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bc_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bc_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;bc&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ic_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ic_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ic&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Sampled Points&quot;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The cell below is the training loop. Play with the hyperparameters, change them and see how they affect the training.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>  <span class="c1"># Set seed for reproducibility</span>

<span class="c1"># simple pinn architecture</span>
<span class="n">arch</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">60</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Input layer, hidden layers, output layer</span>
<span class="n">act</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span>  <span class="c1"># Activation function</span>
<span class="n">net_u</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="n">arch</span><span class="p">,</span> <span class="n">act</span><span class="p">)</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;mps&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

<span class="n">model_wave</span> <span class="o">=</span> <span class="n">PINN_wave</span><span class="p">(</span><span class="n">net_u</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1"># create the sampler for the problem</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">Sampler</span><span class="p">(</span><span class="n">spans</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model_wave</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>  <span class="c1"># Optimizer to use</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>  <span class="c1"># Loss function</span>

<span class="c1"># number of base points to evaluate the residual or gradients and then use them for adaptive sampling</span>
<span class="n">NUM_DOM</span> <span class="o">=</span> <span class="mi">900</span>  <span class="c1"># Number of domain points</span>
<span class="n">NUM_IC</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Number of initial condition points</span>
<span class="n">NUM_BC</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Number of boundary condition points</span>

<span class="n">SAMPLING_METHODS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lhs&#39;</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">]</span>  <span class="c1"># [residual points, initial condition points, boundary condition points] lhs, grid or random</span>

<span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="n">NTK_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># Batch size for NTK calculations</span>
<span class="n">WEIGHT_UPDATE_INTERVAL</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Update weights every 1000 iterations</span>

<span class="n">ADAPTIVE_SAMPLING_METHOD</span> <span class="o">=</span> <span class="s1">&#39;gar&#39;</span>  <span class="c1"># gar or rar</span>
<span class="n">RESAMPLE_FREQUENCY</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Resample every 1000 epochs</span>
<span class="n">NUM_ADAPTIVE_BASE_POINTS</span> <span class="o">=</span> <span class="mi">30000</span> <span class="c1"># Number of base points for adaptive sampling</span>
<span class="n">NUM_ADAPTIVE_POINTS</span> <span class="o">=</span> <span class="mi">2000</span> <span class="c1"># Number of adaptive points to sample from those base points</span>

<span class="n">ic_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">):</span>
    <span class="n">model_wave</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">RESAMPLE_FREQUENCY</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Sample new points</span>
        <span class="n">dom_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="p">,</span> <span class="n">bc_left_points</span><span class="p">,</span> <span class="n">bc_right_points</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_dom</span><span class="o">=</span><span class="n">NUM_DOM</span><span class="p">,</span> <span class="n">num_ic</span><span class="o">=</span><span class="n">NUM_IC</span><span class="p">,</span> <span class="n">num_bc</span><span class="o">=</span><span class="n">NUM_BC</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">SAMPLING_METHODS</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">model_wave</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">dom_points</span> <span class="o">=</span> <span class="n">dom_points</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model_wave</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">adaptive_base_points</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample_domain_points</span><span class="p">(</span><span class="n">num_points</span><span class="o">=</span><span class="n">NUM_ADAPTIVE_BASE_POINTS</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">model_wave</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">adaptive_points</span> <span class="o">=</span> <span class="n">model_wave</span><span class="o">.</span><span class="n">adaptive_sampling</span><span class="p">(</span><span class="n">num_points</span><span class="o">=</span><span class="n">NUM_ADAPTIVE_POINTS</span><span class="p">,</span> <span class="n">base_grid_points</span><span class="o">=</span><span class="n">adaptive_base_points</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">ADAPTIVE_SAMPLING_METHOD</span><span class="p">)</span>

        <span class="c1"># Combine the adaptive points with the sampled points</span>
        <span class="n">combined_domain</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">dom_points</span><span class="p">,</span> <span class="n">adaptive_points</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">bc_points</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">bc_left_points</span><span class="p">,</span> <span class="n">bc_right_points</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">x_dom</span> <span class="o">=</span> <span class="n">combined_domain</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model_wave</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t_dom</span> <span class="o">=</span> <span class="n">combined_domain</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model_wave</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x_ic</span> <span class="o">=</span> <span class="n">ic_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model_wave</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t_ic</span> <span class="o">=</span> <span class="n">ic_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model_wave</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x_bc</span> <span class="o">=</span> <span class="n">bc_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model_wave</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t_bc</span> <span class="o">=</span> <span class="n">bc_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model_wave</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">pde_residual</span> <span class="o">=</span> <span class="n">model_wave</span><span class="o">.</span><span class="n">pde_residual</span><span class="p">(</span><span class="n">x_dom</span><span class="p">,</span> <span class="n">t_dom</span><span class="p">)</span>
    <span class="n">pde_loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">pde_residual</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pde_residual</span><span class="p">))</span>
    <span class="n">bc_forward</span> <span class="o">=</span> <span class="n">model_wave</span><span class="o">.</span><span class="n">net_u</span><span class="p">(</span><span class="n">x_bc</span><span class="p">,</span> <span class="n">t_bc</span><span class="p">)</span>
    <span class="n">bc_loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">bc_forward</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">bc_forward</span><span class="p">))</span>
    <span class="n">ic_neumann_res</span> <span class="o">=</span> <span class="n">model_wave</span><span class="o">.</span><span class="n">u_t_func</span><span class="p">(</span><span class="n">x_ic</span><span class="p">,</span> <span class="n">t_ic</span><span class="p">)</span>
    <span class="n">ic_neumann_loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">ic_neumann_res</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ic_neumann_res</span><span class="p">))</span>
    <span class="n">ic_forward</span> <span class="o">=</span> <span class="n">model_wave</span><span class="o">.</span><span class="n">net_u</span><span class="p">(</span><span class="n">x_ic</span><span class="p">,</span> <span class="n">t_ic</span><span class="p">)</span>
    <span class="n">ic_real</span> <span class="o">=</span> <span class="n">ic_func</span><span class="p">(</span><span class="n">x_ic</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">ic_loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">ic_forward</span><span class="p">,</span> <span class="n">ic_real</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">WEIGHT_UPDATE_INTERVAL</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Calculate NTK-based adaptive weights</span>
        <span class="n">ntk_weights</span> <span class="o">=</span> <span class="n">model_wave</span><span class="o">.</span><span class="n">calculate_adaptive_weights</span><span class="p">(</span>
            <span class="p">[</span><span class="n">pde_residual</span><span class="p">,</span> <span class="n">ic_forward</span><span class="p">,</span> <span class="n">bc_forward</span><span class="p">,</span> <span class="n">ic_neumann_res</span><span class="p">],</span>
            <span class="n">sampling_strategy</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">NTK_BATCH_SIZE</span><span class="p">,</span>
            <span class="n">return_info</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">pde_weight</span><span class="p">,</span> <span class="n">ic_weight</span><span class="p">,</span> <span class="n">bc_weight</span><span class="p">,</span> <span class="n">ic_neumann_weight</span> <span class="o">=</span> <span class="n">ntk_weights</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ic_loss: </span><span class="si">{</span><span class="n">ic_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;bc_loss: </span><span class="si">{</span><span class="n">bc_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;pde_loss: </span><span class="si">{</span><span class="n">pde_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ic_neu_loss: </span><span class="si">{</span><span class="n">ic_neumann_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="n">total_loss</span> <span class="o">=</span> <span class="n">ic_weight</span> <span class="o">*</span> <span class="n">ic_loss</span> \
        <span class="o">+</span> <span class="n">bc_weight</span> <span class="o">*</span> <span class="n">bc_loss</span> \
        <span class="o">+</span> <span class="n">pde_weight</span> <span class="o">*</span> <span class="n">pde_loss</span> \
        <span class="o">+</span> <span class="n">ic_neumann_weight</span> <span class="o">*</span> <span class="n">ic_neumann_loss</span>
    
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">WEIGHT_UPDATE_INTERVAL</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ic_weig: </span><span class="si">{</span><span class="n">ic_weight</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;bc_weig: </span><span class="si">{</span><span class="n">bc_weight</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;pde_weigt: </span><span class="si">{</span><span class="n">pde_weight</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ic_neu_weig: </span><span class="si">{</span><span class="n">ic_neumann_weight</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;total_loss: </span><span class="si">{</span><span class="n">total_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">model_wave</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">dom_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="p">,</span> <span class="n">bc_points</span><span class="p">,</span> <span class="n">adaptive_points</span><span class="p">)</span>

    <span class="n">total_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<span class="n">model_wave</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">dom_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="p">,</span> <span class="n">bc_points</span><span class="p">,</span> <span class="n">adaptive_points</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>epoch: 0, ic_loss: 7.2734e-01, bc_loss: 6.4594e-03, pde_loss: 4.9399e-05, ic_neu_loss: 4.7023e-06
epoch: 0, ic_weig: 2.4549e+00, bc_weig: 2.3711e+00, pde_weigt: 8.6647e+00, ic_neu_weig: 1.8021e+01, total_loss: 1.8014e+00
L2 Normalized Relative Error: 1.0117
epoch: 1000, ic_loss: 1.9219e-01, bc_loss: 3.6706e-02, pde_loss: 4.5894e-03, ic_neu_loss: 2.1547e-04
epoch: 1000, ic_weig: 1.4281e+01, bc_weig: 1.1662e+01, pde_weigt: 1.4770e+00, ic_neu_weig: 5.9812e+00, total_loss: 3.1809e+00
L2 Normalized Relative Error: 0.9550
epoch: 2000, ic_loss: 1.0659e-01, bc_loss: 2.1000e-02, pde_loss: 1.5534e-02, ic_neu_loss: 7.7174e-03
epoch: 2000, ic_weig: 3.9906e+01, bc_weig: 2.9487e+01, pde_weigt: 1.2279e+00, ic_neu_weig: 7.8963e+00, total_loss: 4.9526e+00
L2 Normalized Relative Error: 0.6118
epoch: 3000, ic_loss: 9.5021e-02, bc_loss: 1.6357e-02, pde_loss: 6.3448e-02, ic_neu_loss: 2.0360e-03
epoch: 3000, ic_weig: 1.1462e+02, bc_weig: 6.9236e+01, pde_weigt: 1.0980e+00, ic_neu_weig: 1.5127e+01, total_loss: 1.2124e+01
L2 Normalized Relative Error: 0.5622
epoch: 4000, ic_loss: 4.2704e-02, bc_loss: 2.1578e-02, pde_loss: 3.3347e-01, ic_neu_loss: 6.3009e-03
epoch: 4000, ic_weig: 1.8135e+03, bc_weig: 9.9665e+02, pde_weigt: 1.0234e+00, ic_neu_weig: 4.7022e+01, total_loss: 9.9587e+01
L2 Normalized Relative Error: 0.5662
epoch: 5000, ic_loss: 1.6925e-03, bc_loss: 1.3112e-02, pde_loss: 1.9907e+01, ic_neu_loss: 4.9378e-03
epoch: 5000, ic_weig: 2.3258e+03, bc_weig: 1.7563e+03, pde_weigt: 1.0336e+00, ic_neu_weig: 3.1758e+01, total_loss: 4.7697e+01
L2 Normalized Relative Error: 0.4481
epoch: 6000, ic_loss: 1.2745e-03, bc_loss: 1.0061e-02, pde_loss: 2.8054e+00, ic_neu_loss: 6.3438e-03
epoch: 6000, ic_weig: 3.1299e+03, bc_weig: 2.1621e+03, pde_weigt: 1.0294e+00, ic_neu_weig: 3.5970e+01, total_loss: 2.8858e+01
L2 Normalized Relative Error: 0.3770
epoch: 7000, ic_loss: 6.2215e-04, bc_loss: 8.6750e-03, pde_loss: 4.5307e+00, ic_neu_loss: 3.5827e-03
epoch: 7000, ic_weig: 3.1466e+03, bc_weig: 2.2130e+03, pde_weigt: 1.0286e+00, ic_neu_weig: 3.7007e+01, total_loss: 2.5949e+01
L2 Normalized Relative Error: 0.3658
epoch: 8000, ic_loss: 1.8207e-03, bc_loss: 1.2472e-02, pde_loss: 3.3746e+00, ic_neu_loss: 5.2254e-02
epoch: 8000, ic_weig: 3.3219e+03, bc_weig: 2.3803e+03, pde_weigt: 1.0262e+00, ic_neu_weig: 4.0281e+01, total_loss: 4.1302e+01
L2 Normalized Relative Error: 0.3954
epoch: 9000, ic_loss: 2.6358e-03, bc_loss: 9.9297e-03, pde_loss: 3.6076e+00, ic_neu_loss: 2.1171e-02
epoch: 9000, ic_weig: 3.2371e+03, bc_weig: 2.2247e+03, pde_weigt: 1.0272e+00, ic_neu_weig: 3.8889e+01, total_loss: 3.5152e+01
L2 Normalized Relative Error: 0.3645
L2 Normalized Relative Error: 0.3575
</pre></div>
</div>
<img alt="../_images/33e4a70f940f0e35dbba1517e410ec06dff65eca24d3547291484112cc93cf64.png" src="../_images/33e4a70f940f0e35dbba1517e410ec06dff65eca24d3547291484112cc93cf64.png" />
<img alt="../_images/0850e290e82c9819897d1d63f2791e1e638c83e71049f91f2e52bd34de42c44a.png" src="../_images/0850e290e82c9819897d1d63f2791e1e638c83e71049f91f2e52bd34de42c44a.png" />
<img alt="../_images/2e6b8165d5a88947f9903743a38b7e238e8e59dbfb375bedecc9a26d5e73732e.png" src="../_images/2e6b8165d5a88947f9903743a38b7e238e8e59dbfb375bedecc9a26d5e73732e.png" />
<img alt="../_images/fb2e5d935e04c6ab8c5228813f68b29d2f922287cfd7fd34dee935a98f0d74fc.png" src="../_images/fb2e5d935e04c6ab8c5228813f68b29d2f922287cfd7fd34dee935a98f0d74fc.png" />
<img alt="../_images/9fc44427e3a49b22f6ac5cd2cfd339ef85f87f9fce56f064554d0eeee8c78047.png" src="../_images/9fc44427e3a49b22f6ac5cd2cfd339ef85f87f9fce56f064554d0eeee8c78047.png" />
<img alt="../_images/d071f6edab975413ab71e24443c254fc31dac1c4cdab0b199a2cad95c89b39ca.png" src="../_images/d071f6edab975413ab71e24443c254fc31dac1c4cdab0b199a2cad95c89b39ca.png" />
<img alt="../_images/bdc44b8a828411baf0e9147ec378c4e2741740d5ca080993ecee519776fd83ba.png" src="../_images/bdc44b8a828411baf0e9147ec378c4e2741740d5ca080993ecee519776fd83ba.png" />
<img alt="../_images/255440fee82514209a0054e19f62c9ae3612e15a9a4c8a51354c5c6fdd4daf53.png" src="../_images/255440fee82514209a0054e19f62c9ae3612e15a9a4c8a51354c5c6fdd4daf53.png" />
<img alt="../_images/884be9afd12ed897019898d3ad1247a218d31ac22f4b61e7f34af26a82b3fd3a.png" src="../_images/884be9afd12ed897019898d3ad1247a218d31ac22f4b61e7f34af26a82b3fd3a.png" />
<img alt="../_images/c343b8926fb539b57c0e0914c7f592f6a10b8e3e42d3e789c7b6bf2b4f91b6d1.png" src="../_images/c343b8926fb539b57c0e0914c7f592f6a10b8e3e42d3e789c7b6bf2b4f91b6d1.png" />
<img alt="../_images/06c6991e1935c4bf8c8d0fbffda70feb149359527b6e44bbdbd64ad2a2617e94.png" src="../_images/06c6991e1935c4bf8c8d0fbffda70feb149359527b6e44bbdbd64ad2a2617e94.png" />
</div>
</div>
<p>Result doesnt look too promising still, probably training further with Adam optimizer would increase the accuracy. However it converges very slow and. We can use another optimizer called <code class="docutils literal notranslate"><span class="pre">LBFGS</span></code>. THe usage of it is slightly different than other otimizer. It requires to wrap the loss calculation in a closure function, because internally the optimzer calls this function several time to keep track of the gradients. Thats also why it is a very memory intensive optimizer but also it is proven that it works well with PINN optimizations, especially first training with <code class="docutils literal notranslate"><span class="pre">ADAM</span></code> then with <code class="docutils literal notranslate"><span class="pre">LBFGS</span></code> is proven to produce better results most of the time.  Below we continue to train the model using <code class="docutils literal notranslate"><span class="pre">LBFGS</span></code>, for a maximum of 10000 iterations but the optimzer most likely stops before that. <code class="docutils literal notranslate"><span class="pre">One</span> <span class="pre">last</span> <span class="pre">note</span> <span class="pre">about</span> <span class="pre">training</span> <span class="pre">with</span> <span class="pre">LBFGS</span> <span class="pre">is</span> <span class="pre">that,</span> <span class="pre">because</span> <span class="pre">it</span> <span class="pre">uses</span> <span class="pre">the</span> <span class="pre">gradients</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">rpevious</span> <span class="pre">steps</span> <span class="pre">in</span> <span class="pre">optimization</span> <span class="pre">we</span> <span class="pre">cannot</span> <span class="pre">use</span> <span class="pre">adaptive</span> <span class="pre">sampling</span> <span class="pre">strategies</span> <span class="pre">inside</span> <span class="pre">the</span> <span class="pre">internal</span> <span class="pre">steps.</span> <span class="pre">But</span> <span class="pre">instead</span> <span class="pre">we</span> <span class="pre">can</span> <span class="pre">create</span> <span class="pre">outer</span> <span class="pre">loops</span> <span class="pre">to</span> <span class="pre">create</span> <span class="pre">to</span> <span class="pre">resample.</span> <span class="pre">We</span> <span class="pre">dont</span> <span class="pre">need</span> <span class="pre">adaptive</span> <span class="pre">sampling</span> <span class="pre">here</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">optimizer_lbfgs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">LBFGS</span><span class="p">(</span><span class="n">model_wave</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">max_eval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">tolerance_grad</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">tolerance_change</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">line_search_fn</span><span class="o">=</span><span class="s1">&#39;strong_wolfe&#39;</span><span class="p">)</span>

<span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">def</span><span class="w"> </span><span class="nf">closure</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">iteration</span>        
    <span class="k">global</span> <span class="n">ic_weight</span><span class="p">,</span> <span class="n">bc_weight</span><span class="p">,</span> <span class="n">pde_weight</span><span class="p">,</span> <span class="n">ic_neumann_weight</span>
    <span class="n">optimizer_lbfgs</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">pde_residual</span> <span class="o">=</span> <span class="n">model_wave</span><span class="o">.</span><span class="n">pde_residual</span><span class="p">(</span><span class="n">x_dom</span><span class="p">,</span> <span class="n">t_dom</span><span class="p">)</span>
    <span class="n">pde_loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">pde_residual</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pde_residual</span><span class="p">))</span>
    <span class="n">bc_forward</span> <span class="o">=</span> <span class="n">model_wave</span><span class="o">.</span><span class="n">net_u</span><span class="p">(</span><span class="n">x_bc</span><span class="p">,</span> <span class="n">t_bc</span><span class="p">)</span>
    <span class="n">bc_loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">bc_forward</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">bc_forward</span><span class="p">))</span>
    <span class="n">ic_neumann_res</span> <span class="o">=</span> <span class="n">model_wave</span><span class="o">.</span><span class="n">u_t_func</span><span class="p">(</span><span class="n">x_ic</span><span class="p">,</span> <span class="n">t_ic</span><span class="p">)</span>
    <span class="n">ic_neumann_loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">ic_neumann_res</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ic_neumann_res</span><span class="p">))</span>
    <span class="n">ic_forward</span> <span class="o">=</span> <span class="n">model_wave</span><span class="o">.</span><span class="n">net_u</span><span class="p">(</span><span class="n">x_ic</span><span class="p">,</span> <span class="n">t_ic</span><span class="p">)</span>
    <span class="n">ic_real</span> <span class="o">=</span> <span class="n">ic_func</span><span class="p">(</span><span class="n">x_ic</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
    <span class="n">ic_loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">ic_forward</span><span class="p">,</span> <span class="n">ic_real</span><span class="p">)</span>

    <span class="n">total_loss</span> <span class="o">=</span> <span class="n">ic_weight</span> <span class="o">*</span> <span class="n">ic_loss</span> \
    <span class="o">+</span> <span class="n">bc_weight</span> <span class="o">*</span> <span class="n">bc_loss</span> \
    <span class="o">+</span> <span class="n">pde_weight</span> <span class="o">*</span> <span class="n">pde_loss</span> \
    <span class="o">+</span> <span class="n">ic_neumann_weight</span> <span class="o">*</span> <span class="n">ic_neumann_loss</span>
        

    <span class="k">if</span> <span class="n">iteration</span> <span class="o">%</span> <span class="n">WEIGHT_UPDATE_INTERVAL</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">: pde_loss = </span><span class="si">{</span><span class="n">pde_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, ic_loss = </span><span class="si">{</span><span class="n">ic_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, bc_loss = </span><span class="si">{</span><span class="n">bc_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, ic_neumann_loss = </span><span class="si">{</span><span class="n">ic_neumann_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">,  Loss = </span><span class="si">{</span><span class="n">total_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Calculate NTK-based adaptive weights</span>
        <span class="n">ntk_weights</span> <span class="o">=</span> <span class="n">model_wave</span><span class="o">.</span><span class="n">calculate_adaptive_weights</span><span class="p">(</span>
            <span class="p">[</span><span class="n">pde_residual</span><span class="p">,</span> <span class="n">ic_forward</span><span class="p">,</span> <span class="n">bc_forward</span><span class="p">,</span> <span class="n">ic_neumann_res</span><span class="p">],</span>
            <span class="n">sampling_strategy</span><span class="o">=</span><span class="s1">&#39;random&#39;</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">NTK_BATCH_SIZE</span><span class="p">,</span>
            <span class="n">return_info</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">pde_weight</span><span class="p">,</span> <span class="n">ic_weight</span><span class="p">,</span> <span class="n">bc_weight</span><span class="p">,</span> <span class="n">ic_neumann_weight</span> <span class="o">=</span> <span class="n">ntk_weights</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ic_weig: </span><span class="si">{</span><span class="n">ic_weight</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;bc_weig: </span><span class="si">{</span><span class="n">bc_weight</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;pde_weigt: </span><span class="si">{</span><span class="n">pde_weight</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ic_neu_weig: </span><span class="si">{</span><span class="n">ic_neumann_weight</span><span class="si">:</span><span class="s2">.4e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
        <span class="n">model_wave</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">dom_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="p">,</span> <span class="n">bc_points</span><span class="p">,</span> <span class="n">adaptive_points</span><span class="p">)</span>
        

    <span class="n">total_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">total_loss</span>

<span class="n">optimizer_lbfgs</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">closure</span><span class="p">)</span>
<span class="n">model_wave</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">dom_points</span><span class="p">,</span> <span class="n">ic_points</span><span class="p">,</span> <span class="n">bc_points</span><span class="p">,</span> <span class="n">adaptive_points</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration 0: pde_loss = 2.7910e+00, ic_loss = 4.3018e-04, bc_loss = 6.9757e-03, ic_neumann_loss = 1.5748e-03,  Loss = 2.2302e+01
Iteration 0, ic_weig: 3.4093e+03, bc_weig: 2.3388e+03, pde_weigt: 1.0263e+00, ic_neu_weig: 4.0102e+01
L2 Normalized Relative Error: 0.3575
Iteration 1000: pde_loss = 2.7293e+00, ic_loss = 1.1878e-04, bc_loss = 2.7963e-03, ic_neumann_loss = 1.0867e-03,  Loss = 9.7898e+00
Iteration 1000, ic_weig: 1.6680e+03, bc_weig: 1.0159e+03, pde_weigt: 1.0237e+00, ic_neu_weig: 4.6451e+01
L2 Normalized Relative Error: 0.2348
Iteration 2000: pde_loss = 7.0468e-01, ic_loss = 4.0706e-05, bc_loss = 1.8982e-03, ic_neumann_loss = 3.5639e-04,  Loss = 2.7342e+00
Iteration 2000, ic_weig: 1.2102e+03, bc_weig: 7.7053e+02, pde_weigt: 1.0324e+00, ic_neu_weig: 3.4151e+01
L2 Normalized Relative Error: 0.1493
Iteration 3000: pde_loss = 1.7572e-01, ic_loss = 1.3929e-05, bc_loss = 2.9209e-04, ic_neumann_loss = 3.1708e-04,  Loss = 4.3416e-01
Iteration 3000, ic_weig: 1.1036e+03, bc_weig: 6.5261e+02, pde_weigt: 1.0349e+00, ic_neu_weig: 3.1929e+01
L2 Normalized Relative Error: 0.0410
Iteration 4000: pde_loss = 5.3709e-02, ic_loss = 9.4326e-06, bc_loss = 7.1547e-05, ic_neumann_loss = 1.3216e-04,  Loss = 1.1691e-01
Iteration 4000, ic_weig: 9.6391e+02, bc_weig: 5.6811e+02, pde_weigt: 1.0350e+00, ic_neu_weig: 3.2258e+01
L2 Normalized Relative Error: 0.0256
Iteration 5000: pde_loss = 2.2829e-02, ic_loss = 1.0572e-05, bc_loss = 3.6081e-05, ic_neumann_loss = 7.7185e-05,  Loss = 5.6806e-02
Iteration 5000, ic_weig: 8.4387e+02, bc_weig: 5.1471e+02, pde_weigt: 1.0364e+00, ic_neu_weig: 3.1289e+01
L2 Normalized Relative Error: 0.0203
Iteration 6000: pde_loss = 1.3637e-02, ic_loss = 5.6790e-06, bc_loss = 2.2054e-05, ic_neumann_loss = 5.4204e-05,  Loss = 3.1972e-02
Iteration 6000, ic_weig: 7.3323e+02, bc_weig: 4.6507e+02, pde_weigt: 1.0388e+00, ic_neu_weig: 2.9579e+01
L2 Normalized Relative Error: 0.0149
Iteration 7000: pde_loss = 9.4837e-03, ic_loss = 2.9458e-06, bc_loss = 1.4323e-05, ic_neumann_loss = 3.3326e-05,  Loss = 1.9658e-02
Iteration 7000, ic_weig: 6.4029e+02, bc_weig: 4.1000e+02, pde_weigt: 1.0422e+00, ic_neu_weig: 2.7399e+01
L2 Normalized Relative Error: 0.0113
Iteration 8000: pde_loss = 6.2462e-03, ic_loss = 1.5646e-06, bc_loss = 1.2140e-05, ic_neumann_loss = 1.6898e-05,  Loss = 1.2952e-02
Iteration 8000, ic_weig: 6.4975e+02, bc_weig: 4.1334e+02, pde_weigt: 1.0400e+00, ic_neu_weig: 2.8950e+01
L2 Normalized Relative Error: 0.0098
L2 Normalized Relative Error: 0.0098
</pre></div>
</div>
<img alt="../_images/06c6991e1935c4bf8c8d0fbffda70feb149359527b6e44bbdbd64ad2a2617e94.png" src="../_images/06c6991e1935c4bf8c8d0fbffda70feb149359527b6e44bbdbd64ad2a2617e94.png" />
<img alt="../_images/370659fa8899e487762e15ff66b6df9563ba2350f34a5818f28c50ec5c514989.png" src="../_images/370659fa8899e487762e15ff66b6df9563ba2350f34a5818f28c50ec5c514989.png" />
<img alt="../_images/ad884c81971b296e776dcc4bd14312079d5282b7e5047666a4ec44cbfdb0ebe2.png" src="../_images/ad884c81971b296e776dcc4bd14312079d5282b7e5047666a4ec44cbfdb0ebe2.png" />
<img alt="../_images/5f9c57ab0a38e59a9bae051789446b69c28e85d52477ff173103fb2bf2b11bcb.png" src="../_images/5f9c57ab0a38e59a9bae051789446b69c28e85d52477ff173103fb2bf2b11bcb.png" />
<img alt="../_images/693474caf01288c73f42a0f48a25f3f80535b38d9a44c98f571a9d78aed3f190.png" src="../_images/693474caf01288c73f42a0f48a25f3f80535b38d9a44c98f571a9d78aed3f190.png" />
<img alt="../_images/d0e8ab0b11b25b78b42010d5421f002e4e71a669eba11bef1f0b46f1012582ae.png" src="../_images/d0e8ab0b11b25b78b42010d5421f002e4e71a669eba11bef1f0b46f1012582ae.png" />
<img alt="../_images/65d8b666a85ce7997bf27a8cc8677d13d2565723207c16464356745c4c55c56b.png" src="../_images/65d8b666a85ce7997bf27a8cc8677d13d2565723207c16464356745c4c55c56b.png" />
<img alt="../_images/32a5182d0773146d1a15345a1ea66bb0e2beab06455cd9ddf7ace1ee86cf28a2.png" src="../_images/32a5182d0773146d1a15345a1ea66bb0e2beab06455cd9ddf7ace1ee86cf28a2.png" />
<img alt="../_images/661472088e7345f618b141081af9a1b416635aafbf97c0a5fb631b27da2f8e5a.png" src="../_images/661472088e7345f618b141081af9a1b416635aafbf97c0a5fb631b27da2f8e5a.png" />
<img alt="../_images/661472088e7345f618b141081af9a1b416635aafbf97c0a5fb631b27da2f8e5a.png" src="../_images/661472088e7345f618b141081af9a1b416635aafbf97c0a5fb631b27da2f8e5a.png" />
</div>
</div>
<section id="references">
<h3>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Aditi S. Krishnapriyan, Amir Gholami, Shandian Zhe, Robert M. Kirby, Michael W. Mahoney. (2021). Characterizing possible failure modes in physics-informed neural networks. 35th Conference on Neural Information Processing Systems. <a class="reference external" href="https://arxiv.org/abs/2109.01050">https://arxiv.org/abs/2109.01050</a></p></li>
<li><p>Chenxi Wu, Min Zhu, Qinyang Tan, Yadhu Kartha, &amp; Lu Lu. (2023). A comprehensive study of non-adaptive and residual-based adaptive sampling for physics-informed neural networks. Computer Methods in Applied Mechanics and Engineering. <a class="reference external" href="https://arxiv.org/abs/2207.10289">https://arxiv.org/abs/2207.10289</a></p></li>
<li><p>Sifan Wang, Shyam Sankaran, Hanwen Wang, &amp; Paris Perdikaris. (2023). An Expert’s Guide to Training Physics-informed Neural Networks. <a class="reference external" href="https://arxiv.org/abs/2308.08468">https://arxiv.org/abs/2308.08468</a></p></li>
<li><p>Nanxi Chen, Sergio Lucarini, Rujin Ma, Airong Chen, &amp; Chuanjie Cui. (2025). PF-PINNs: Physics-informed neural networks for solving coupled Allen-Cahn and Cahn-Hilliard phase field equations. Journal of Computational Physics. <a class="reference external" href="https://doi.org/10.1016/j.jcp.2025.113843">https://doi.org/10.1016/j.jcp.2025.113843</a></p></li>
</ul>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./content"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Lecture_4.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Introduction to Physics Informed Neural Networks (PINNs)</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#curriculim-learning">Curriculim Learning</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sampling-strategy">Sampling Strategy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-weights">Adaptive Weights</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#references">References</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>